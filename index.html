<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ODIERO'S Trustvault</title>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ---------- Global / layout ---------- */
    :root{
      --green: #1e8f3e;
      --bg: #f3f6f9;
      --card: #ffffff;
      --muted: #6b7280;
      --shadow: 0 6px 18px rgba(15,23,42,0.06);
      --danger: #d9534f;
      --maxwidth: 1200px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#0f1724;background:var(--bg);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;overflow:hidden}
    /* App layout: sidebar + main */
    .app { display:flex; height:100vh; align-items:stretch; justify-content:center; padding:0; }
    /* ---------- Sidebar (no border radius) ---------- */
    .sidebar {
      width:240px;
      background:var(--green);
      color:#fff;
      padding:22px;
      display:flex;
      flex-direction:column;
      gap:12px;
      box-shadow:var(--shadow);
      flex-shrink:0;
      height:100vh;
      overflow:hidden;
    }
    .brand { display:flex; align-items:center; gap:12px; }
    .brand .logo {
      width:44px;height:44px;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;font-weight:700;border-radius:6px;
    }
    .brand h1{font-size:16px;margin:0}
    .brand small{font-size:12px;opacity:0.95}
    .nav { margin-top:8px; display:flex;flex-direction:column; gap:6px; }
    .nav button {
      text-align:left; background:transparent;border:0;color:inherit;padding:10px 8px; cursor:pointer; font-size:14px;
    }
    .nav button:hover, .nav button.active { background: rgba(0,0,0,0.12); }
    .sidebar .status { margin-top:auto; font-size:13px; opacity:0.95 }
    .sidebar .status .dot { width:10px;height:10px;border-radius:50%;display:inline-block;vertical-align:middle;margin-right:8px;background:#39d353; }

    /* ---------- Main area ---------- */
    .main-wrap { flex:1; display:flex; flex-direction:column; align-items:stretch; justify-content:flex-start; padding:18px; max-width:var(--maxwidth); width:100%; }
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
    .title { font-size:18px; font-weight:700; letter-spacing:0.2px }
    .top-actions { display:flex; gap:8px; align-items:center; }

    /* ---------- Cards row ---------- */
    .cards-row { display:flex; gap:12px; margin-bottom:12px; }
    .card {
      background:var(--card); padding:12px; box-shadow:var(--shadow); border-radius:8px; flex:1; min-width:160px;
      display:flex; flex-direction:column; justify-content:center;
    }
    .card h4{margin:0;font-size:13px;color:var(--muted)}
    .card .value{margin-top:6px;font-size:18px;font-weight:700}

    /* ---------- Pages: each page fits the viewport (no page scrolling) ---------- */
    .pages { flex:1; display:flex; gap:12px; }
    .page { flex:1; display:none; height: calc(100vh - 170px); /* topbar + cards-row space accounted approx */ overflow:hidden; }
    .page.active { display:block; }

    /* Dashboard grid - left (main) and right (side) */
    .dashboard-grid { display:grid; grid-template-columns: 1fr 360px; gap:12px; height:100%; }
    .left-col { display:flex; flex-direction:column; gap:12px; overflow:hidden; }
    .hist-card { background:var(--card); padding:12px; border-radius:8px; box-shadow:var(--shadow); display:flex; flex-direction:column; justify-content:center; height:56%; }
    .summary-card { background:var(--card); padding:12px; border-radius:8px; box-shadow:var(--shadow); height:40%; display:flex; flex-direction:column; justify-content:center; }
    .top-contrib { background:var(--card); padding:12px; border-radius:8px; box-shadow:var(--shadow); height:40%; overflow:auto; }

    /* right side */
    .right-col { display:flex; flex-direction:column; gap:12px; height:100%; }
    .quick-actions { background:var(--card); padding:12px; border-radius:8px; box-shadow:var(--shadow); display:flex; flex-direction:column; gap:8px; height:36%; }
    .target-card { background:var(--card); padding:12px; border-radius:8px; box-shadow:var(--shadow); height:60%; }

    /* ---------- Tables & lists ---------- */
    table { width:100%; border-collapse:collapse; font-size:13px; background:transparent; }
    thead th { text-align:left; padding:8px; background:#fbfdff; font-weight:600; color:#0f1724; border-bottom:1px solid #f1f5f9; }
    tbody td { padding:8px; border-bottom:1px solid #f1f5f9; }
    .muted { color:var(--muted); font-size:13px; }

    /* ---------- Forms ---------- */
    input, select { padding:8px 10px; border-radius:6px; border:1px solid #e6eef6; font-size:14px; }
    .btn { padding:8px 10px; border-radius:6px; border:0; cursor:pointer; font-weight:600; }
    .btn.primary { background:var(--green); color:#fff; }
    .btn.ghost { background:transparent; border:1px solid #e6eef6; }

    /* ---------- Modal & toast ---------- */
    .modal-backdrop { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:9999; }
    .modal { background:#fff; padding:16px; border-radius:10px; width:420px; box-shadow:0 12px 40px rgba(0,0,0,0.25); }
    .modal .actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
    .toast { position:fixed; right:18px; bottom:18px; background:#fff; padding:10px 14px; border-radius:8px; box-shadow:var(--shadow); z-index:9998; min-width:220px; }

    /* ---------- Small screens fallback ---------- */
    @media (max-width:980px){
      .dashboard-grid { grid-template-columns: 1fr; grid-template-rows: auto auto; }
      .right-col { flex-direction:row; gap:8px; }
    }
  </style>
</head>
<body>
  <!-- PASSWORD GATE -->
  <div id="loginGate" style="position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg,#eefaf0,#f3f6f9); z-index:99999;">
    <div style="width:360px; background:var(--card); padding:20px; border-radius:10px; box-shadow:var(--shadow); text-align:center;">
      <h2 style="margin:0 0 8px">Access Trustvault</h2>
      <p class="muted" style="margin:0 0 12px">Enter the access password to continue</p>
      <input id="loginPassword" type="password" placeholder="Password" style="width:100%; padding:10px; border-radius:8px; border:1px solid #e6eef6; margin-bottom:10px" />
      <div style="display:flex; gap:8px; justify-content:center;">
        <button id="loginBtn" class="btn primary">Enter</button>
        <button id="demoBtn" class="btn ghost">Use Demo</button>
      </div>
      <p class="muted" style="margin-top:12px; font-size:13px">Default password if unchanged: <strong>admin123</strong></p>
    </div>
  </div>

  <!-- APP -->
  <div id="appRoot" class="app" style="display:none">
    <div class="sidebar" aria-label="Sidebar">
      <div class="brand">
        <div class="logo">TV</div>
        <div>
          <h1>ODIERO'S Trustvault</h1>
          <small>Secure Your Money, Secure Your Future</small>
        </div>
      </div>

      <nav class="nav" aria-label="Main navigation">
        <button data-page="dashboard" class="active">Dashboard</button>
        <button data-page="members">Members</button>
        <button data-page="savings">Savings</button>
        <button data-page="reports">Reports</button>
        <button data-page="notes">Notes</button>
        <button data-page="settings">Settings</button>
        <button data-page="faq">FAQ</button>
      </nav>

      <div class="status">
        <div><span class="dot"></span>Online</div>
        <div class="muted" style="margin-top:8px">Last update: just now</div>
      </div>
    </div>

    <div class="main-wrap">
      <div class="topbar">
        <div class="title" id="headerTitle">ODIERO'S Trustvault</div>
        <div class="top-actions">
          <div class="muted" style="text-align:right">Welcome, <strong id="adminName">Admin</strong></div>
          <button id="logoutBtn" class="btn ghost" style="margin-left:8px">Logout</button>
        </div>
      </div>

      <!-- top cards -->
      <div class="cards-row">
        <div class="card">
          <h4>Number of Members</h4>
          <div class="value" id="cardMembers">0</div>
          <div class="muted">Active this period: <span id="cardActive">0</span></div>
        </div>
        <div class="card">
          <h4>Total Savings</h4>
          <div class="value" id="cardTotalSavings">KES 0</div>
          <div class="muted">Target: KES <span id="cardTarget">70,000</span></div>
        </div>
        <div class="card">
          <h4>Pending Savings</h4>
          <div class="value" id="cardPending">KES 0</div>
          <div class="muted">Unconfirmed contributions</div>
        </div>
        <div class="card">
          <h4>Active Members</h4>
          <div class="value" id="cardActiveMembers">0</div>
          <div class="muted">Members who saved at least once</div>
        </div>
      </div>

      <!-- pages container -->
      <div class="pages">
        <!-- Dashboard -->
        <section id="dashboard" class="page active">
          <div class="dashboard-grid">
            <div class="left-col">
              <div class="hist-card">
                <h3 style="margin:0 0 8px">Members Savings Percentage of Total</h3>
                <canvas id="histogramCanvas" height="180"></canvas>
                <div class="muted" style="margin-top:8px; font-size:13px">Percentages rounded to one decimal; chart aims to sum to 100%.</div>
              </div>

              <div class="summary-card" style="display:flex;flex-direction:row;gap:12px;align-items:center;">
                <div style="flex:1">
                  <div class="muted">2025-09-28</div>
                  <div style="font-weight:700">KES 57</div>
                </div>
                <div style="flex:1">
                  <div class="muted">2025-09-21</div>
                  <div style="font-weight:700">KES 4,420</div>
                </div>
                <div style="flex:1;text-align:right">
                  <div class="muted">Alerts</div>
                  <div id="alertsText" style="color:var(--danger);font-weight:700;margin-top:6px">Savings less than 25% of target.</div>
                </div>
              </div>

              <div class="top-contrib">
                <h4 style="margin:0 0 8px">Top Contributors (This Month)</h4>
                <table style="width:100%">
                  <thead><tr><th>Name</th><th style="text-align:right">Amount</th></tr></thead>
                  <tbody id="topContributors"></tbody>
                </table>
              </div>
            </div>

            <div class="right-col">
              <div class="quick-actions">
                <h4 style="margin:0 0 8px">Quick Actions</h4>
                <button class="btn primary" id="addSavingBtn">Add Saving</button>
                <button class="btn ghost" id="manageMembersBtn">Manage Members</button>
                <button class="btn ghost" id="exportCsvBtn">Export CSV</button>
              </div>

              <div class="target-card">
                <h4 style="margin:0 0 8px">Target Settings</h4>
                <div class="muted">Total target (KES)</div>
                <div style="font-weight:700" id="targetValue">70,000</div>
                <div class="muted" style="margin-top:8px">Estimated days to target</div>
                <div style="font-weight:700" id="daysToTarget">360</div>
                <div class="muted" style="margin-top:8px">Min daily savings (KES)</div>
                <div style="font-weight:700" id="minDailyDisplay">30</div>
              </div>
            </div>
          </div>
        </section>

        <!-- Members -->
        <section id="members" class="page" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3>Members</h3>
            <button class="btn primary" id="addMemberBtn">Add Member</button>
          </div>
          <div style="height:10px"></div>
          <table id="membersTable" style="width:100%; table-layout:fixed">
            <thead><tr><th style="width:6%">#</th><th style="width:42%">Name</th><th style="width:30%">Phone/Notes</th><th style="width:12%;text-align:right">Savings</th><th style="width:10%">Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </section>

        <!-- Savings -->
        <section id="savings" class="page" style="display:none">
          <h3>Savings</h3>
          <p class="muted">Add deposits or withdrawals here. Deposits below the daily minimum will require confirmation.</p>

          <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
            <select id="saveMemberSelect" style="width:300px"></select>
            <input id="saveAmountInput" type="number" placeholder="Amount (KES)" />
            <select id="saveType"><option value="deposit">Deposit</option><option value="withdraw">Withdraw</option></select>
            <button class="btn primary" id="applySaveBtn">Apply</button>
          </div>

          <div style="height:12px"></div>

          <div style="background:var(--card); padding:10px; border-radius:8px; box-shadow:var(--shadow); height:60%; overflow:auto">
            <h4 style="margin:0 0 8px">Recent Transactions</h4>
            <table id="transactionsTable">
              <thead><tr><th>Time</th><th>Member</th><th>Action</th><th style="text-align:right">Amount</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <!-- Reports -->
        <section id="reports" class="page" style="display:none">
          <h3>Reports</h3>
          <div style="height:8px"></div>
          <div style="background:var(--card); padding:10px; border-radius:8px; box-shadow:var(--shadow); height:85%; overflow:auto">
            <table id="reportsTable">
              <thead><tr><th>Time</th><th>Member</th><th>Action</th><th style="text-align:right">Amount</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <!-- Notes -->
        <section id="notes" class="page" style="display:none">
          <h3>Notes</h3>
          <div style="height:10px"></div>
          <div style="background:var(--card); padding:12px; border-radius:8px; box-shadow:var(--shadow); height:80%">
            <textarea id="notesArea" style="width:100%; height:100%; padding:8px; border-radius:6px; border:1px solid #e6eef6"></textarea>
            <div style="text-align:right; margin-top:6px">
              <button id="saveNotes" class="btn primary">Save Notes</button>
            </div>
          </div>
        </section>

        <!-- Settings -->
        <section id="settings" class="page" style="display:none">
          <h3>System Configuration & Settings</h3>
          <div style="height:12px"></div>
          <div style="display:grid; grid-template-columns: 1fr 320px; gap:12px; height:80%">
            <div style="background:var(--card); padding:12px; border-radius:8px; box-shadow:var(--shadow); overflow:auto">
              <h4>Target settings</h4>
              <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
                <div style="flex:1">
                  <div class="muted">Total target (KES)</div>
                  <input id="targetInput" type="number" />
                </div>
                <div style="width:120px">
                  <div class="muted">Min daily (KES)</div>
                  <input id="minDailyInput" type="number" />
                </div>
              </div>
              <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end">
                <button id="saveSettingsBtn" class="btn primary">Save Settings</button>
                <button id="resetDataBtn" class="btn ghost">Reset Data</button>
              </div>
            </div>

            <div style="background:var(--card); padding:12px; border-radius:8px; box-shadow:var(--shadow);">
              <h4>Access & Security</h4>
              <div style="margin-top:8px">
                <div class="muted">Access password</div>
                <input id="accessPassword" type="text" placeholder="Change access password" />
                <div style="margin-top:8px; display:flex; gap:8px; justify-content:flex-end">
                  <button id="changePassBtn" class="btn primary">Change</button>
                </div>
              </div>
              <div style="margin-top:16px">
                <label><input type="checkbox" id="autoConfirmCheckbox" /> Auto-confirm savings</label>
              </div>
            </div>
          </div>
        </section>

        <!-- FAQ -->
        <section id="faq" class="page" style="display:none">
          <h3>FAQ</h3>
          <div style="height:10px"></div>
          <div style="background:var(--card); padding:12px; border-radius:8px; box-shadow:var(--shadow); height:80%; overflow:auto">
            <p class="muted"><strong>How are savings stored?</strong> Locally in your browser (localStorage).</p>
            <p class="muted"><strong>How to backup?</strong> Use Export CSV in Quick Actions.</p>
          </div>
        </section>
      </div>

    </div>
  </div>

  <!-- Modal root for confirmation -->
  <div id="modalRoot" style="display:none"></div>

  <!-- Toast container is created dynamically -->

  <script>
  /*
    Full single-file Trustvault app
    - Saves data to localStorage under keys prefixed with "tv_"
    - Default password: admin123 (change in Settings after login)
    - All pages fit the viewport; body overflow hidden
  */

  (function () {
    // Storage keys & defaults
    const KEYS = {
      MEMBERS: 'tv_members',
      REPORTS: 'tv_reports',
      NOTES: 'tv_notes',
      SETTINGS: 'tv_settings',
      AUTH_PASS: 'tv_access_password'
    };

    const DEFAULTS = {
      members: [
        { id: 'm1', name: 'odhis', phone: '', savings: 2220, active: true },
        { id: 'm2', name: 'millicent', phone: '', savings: 760, active: true },
        { id: 'm3', name: 'alpha', phone: '', savings: 757, active: true },
        { id: 'm4', name: 'Jeremiah', phone: '', savings: 740, active: true }
      ],
      settings: {
        target: 70000,
        daysToTarget: 360,
        minDaily: 30,
        autoConfirm: true
      },
      reports: [],
      notes: ''
    };

    // Utilities
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const nowStr = () => {
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    };

    function readJSON(key, fallback) {
      try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; } catch (e) { return fallback; }
    }
    function writeJSON(key, val) { localStorage.setItem(key, JSON.stringify(val)); }

    // Seed localStorage if missing
    if (!localStorage.getItem(KEYS.MEMBERS)) writeJSON(KEYS.MEMBERS, DEFAULTS.members);
    if (!localStorage.getItem(KEYS.SETTINGS)) writeJSON(KEYS.SETTINGS, DEFAULTS.settings);
    if (!localStorage.getItem(KEYS.REPORTS)) writeJSON(KEYS.REPORTS, DEFAULTS.reports);
    if (!localStorage.getItem(KEYS.NOTES)) writeJSON(KEYS.NOTES, DEFAULTS.notes);
    if (!localStorage.getItem(KEYS.AUTH_PASS)) localStorage.setItem(KEYS.AUTH_PASS, 'admin123');

    // Data accessors
    function getMembers(){ return readJSON(KEYS.MEMBERS, []); }
    function saveMembers(arr){ writeJSON(KEYS.MEMBERS, arr); }
    function getReports(){ return readJSON(KEYS.REPORTS, []); }
    function saveReports(arr){ writeJSON(KEYS.REPORTS, arr); }
    function getSettings(){ return readJSON(KEYS.SETTINGS, DEFAULTS.settings); }
    function saveSettings(obj){ writeJSON(KEYS.SETTINGS, obj); }
    function getNotes(){ return readJSON(KEYS.NOTES, ''); }
    function saveNotes(v){ writeJSON(KEYS.NOTES, v); }

    function addReport(entry){
      const arr = getReports();
      arr.unshift({ ...entry, time: nowStr() });
      saveReports(arr);
      renderReportsTable();
    }

    // Toast
    function showToast(title, msg, t=4500){
      const el = document.createElement('div');
      el.className = 'toast';
      el.innerHTML = `<strong>${title}</strong><div style="margin-top:6px">${msg}</div>`;
      document.body.appendChild(el);
      setTimeout(()=> el.remove(), t);
    }

    // Modal confirm
    function showModal(title, body, confirmText='Continue', cancelText='Cancel'){
      return new Promise(resolve => {
        const root = $('#modalRoot');
        root.style.display = 'block';
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop';
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `<div><strong>${title}</strong></div><div style="margin-top:10px">${body}</div><div class="actions"></div>`;
        const actions = modal.querySelector('.actions');
        const btnCancel = document.createElement('button'); btnCancel.className='btn ghost'; btnCancel.textContent = cancelText;
        const btnOk = document.createElement('button'); btnOk.className='btn primary'; btnOk.textContent = confirmText;
        actions.appendChild(btnCancel); actions.appendChild(btnOk);
        backdrop.appendChild(modal);
        root.appendChild(backdrop);

        btnCancel.addEventListener('click', ()=> { backdrop.remove(); root.style.display='none'; resolve(false); });
        btnOk.addEventListener('click', ()=> { backdrop.remove(); root.style.display='none'; resolve(true); });
      });
    }

    // Render: dashboard/histogram/top contributors/cards
    let histogramChart = null;
    function renderDashboard(){
      const members = getMembers();
      const settings = getSettings();
      const total = members.reduce((s,m)=> s + Number(m.savings||0), 0);

      $('#cardMembers').textContent = members.length;
      $('#cardActive').textContent = members.filter(m => m.active).length;
      $('#cardTotalSavings').textContent = 'KES ' + total.toLocaleString();
      $('#cardTarget').textContent = Number(settings.target).toLocaleString();
      $('#cardPending').textContent = 'KES ' + (157).toLocaleString();
      $('#cardActiveMembers').textContent = members.filter(m => Number(m.savings||0) > 0).length;
      $('#minDailyDisplay').textContent = Number(settings.minDaily || 0);

      // top contributors
      const top = [...members].sort((a,b)=> (b.savings||0) - (a.savings||0)).slice(0,6);
      const tc = $('#topContributors'); tc.innerHTML = '';
      top.forEach(t=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${t.name}</td><td style="text-align:right">KES ${Number(t.savings||0).toLocaleString()}</td>`;
        tc.appendChild(tr);
      });

      // histogram: percentages to 1 decimal; distribute residual to largest
      const items = members.map(m => ({ name:m.name, amount: Number(m.savings||0) }));
      const totalAmount = items.reduce((s,i)=>s+i.amount,0);
      const displayed = items.map(it => {
        const pct = totalAmount>0 ? (it.amount/totalAmount)*100 : 0;
        return { ...it, pctRaw: pct, pctDisplay: Math.round(pct*10)/10 };
      });
      let sumDisp = displayed.reduce((s,i)=>s+i.pctDisplay,0);
      let residual = Math.round((100 - sumDisp)*10)/10;
      if (Math.abs(residual) > 0.0001 && displayed.length>0) {
        let idx = 0;
        for (let i=1;i<displayed.length;i++) if (displayed[i].amount > displayed[idx].amount) idx = i;
        displayed[idx].pctDisplay = Math.round((displayed[idx].pctDisplay + residual)*10)/10;
      }

      const labels = displayed.map(d=>d.name);
      const data = displayed.map(d=>d.pctDisplay);
      const amounts = displayed.map(d=>d.amount);

      // clean previous chart
      if (histogramChart) histogramChart.destroy();
      const ctx = document.getElementById('histogramCanvas').getContext('2d');
      histogramChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: '% of total savings', data, backgroundColor: '#1e8f3e' }] },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          scales: { y: { beginAtZero:true, max:100, ticks:{ callback: v => v + '%' } } },
          plugins: {
            tooltip:{ callbacks: { label: (ctx)=> {
              const i = ctx.dataIndex;
              return `${labels[i]} — KES ${amounts[i].toLocaleString()} (${data[i]}%)`;
            } } },
            legend: { display:false }
          }
        }
      });
    }

    // Members table
    function renderMembersTable(){
      const members = getMembers();
      const tbody = document.querySelector('#membersTable tbody');
      tbody.innerHTML = '';
      members.forEach((m, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${m.name}</td>
          <td>${m.phone || ''}</td>
          <td style="text-align:right">KES ${Number(m.savings||0).toLocaleString()}</td>
          <td style="text-align:center">
            <button class="btn ghost edit" data-id="${m.id}">Edit</button>
            <button class="btn ghost delete" data-id="${m.id}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // attach handlers
      tbody.querySelectorAll('button.delete').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.target.dataset.id;
          const members = getMembers();
          const m = members.find(x=>x.id===id);
          if (!m) return;
          // native confirm preserved
          if (!confirm(`Are you sure you want to delete ${m.name}?`)) {
            addReport({ memberId: id, memberName: m.name, action: 'delete-cancelled' });
            return;
          }
          const updated = members.filter(x => x.id !== id);
          saveMembers(updated);
          addReport({ memberId: id, memberName: m.name, action: 'delete' });
          renderAll();
        });
      });

      tbody.querySelectorAll('button.edit').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.target.dataset.id;
          const members = getMembers();
          const m = members.find(x=>x.id===id);
          const newName = prompt('Edit member name', m.name);
          if (newName && newName.trim()) {
            m.name = newName.trim();
            saveMembers(members);
            addReport({ memberId: id, memberName: m.name, action: 'edit-member' });
            renderAll();
          }
        });
      });
    }

    // Savings page
    function ensureSaveMemberSelect(){
      const sel = $('#saveMemberSelect');
      sel.innerHTML = '';
      getMembers().forEach(m=>{
        const o = document.createElement('option'); o.value = m.id; o.textContent = `${m.name} — KES ${Number(m.savings||0).toLocaleString()}`;
        sel.appendChild(o);
      });
    }

    function renderTransactionsTable(){
      const tbody = document.querySelector('#transactionsTable tbody');
      tbody.innerHTML = '';
      const reports = getReports();
      reports.filter(r => ['deposit','withdraw'].includes(r.action)).slice(0,50).forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.time}</td><td>${r.memberName || ''}</td><td>${r.action}</td><td style="text-align:right">${r.amount ? 'KES ' + Number(r.amount).toLocaleString() : ''}</td>`;
        tbody.appendChild(tr);
      });
    }

    // Reports table
    function renderReportsTable(){
      const tbody = document.querySelector('#reportsTable tbody');
      tbody.innerHTML = '';
      getReports().forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.time}</td><td>${r.memberName || ''}</td><td>${r.action}</td><td style="text-align:right">${r.amount ? 'KES ' + Number(r.amount).toLocaleString() : ''}</td>`;
        tbody.appendChild(tr);
      });
    }

    // Notes
    function renderNotes(){
      $('#notesArea').value = getNotes();
    }

    // Settings
    function renderSettings(){
      const s = getSettings();
      $('#targetInput').value = s.target || '';
      $('#minDailyInput').value = s.minDaily || '';
      $('#accessPassword').value = localStorage.getItem(KEYS.AUTH_PASS) || '';
      $('#autoConfirmCheckbox').checked = !!s.autoConfirm;
      $('#targetValue').textContent = Number(s.target||0).toLocaleString();
      $('#daysToTarget').textContent = s.daysToTarget || DEFAULTS.settings.daysToTarget;
      $('#minDailyDisplay').textContent = Number(s.minDaily||0);
    }

    // Add saving (programmatic wrapper)
    window.tvAddSaving = async function(memberId, amount){
      const members = getMembers();
      const m = members.find(x=>x.id===memberId);
      if (!m) throw new Error('Member not found');
      const settings = getSettings();
      if (Number(amount) < Number(settings.minDaily || 0)) {
        const cont = await showModal('Deposit below minimum', `The deposit KES ${amount} is below the daily minimum KES ${settings.minDaily}. Continue?`);
        if (!cont) { addReport({ memberId, memberName: m.name, action:'deposit-cancelled-below-min', amount }); return false; }
      }
      m.savings = Number(m.savings||0) + Number(amount);
      saveMembers(members);
      addReport({ memberId, memberName: m.name, action:'deposit', amount });
      showToast('Deposit', `${m.name} deposited KES ${amount} at ${nowStr()}`);
      renderAll();
      return true;
    };

    // Expose delete wrapper
    window.tvDeleteMember = function(memberId){
      const members = getMembers();
      const m = members.find(x=>x.id===memberId);
      if (!m) return false;
      if (!confirm(`Are you sure you want to delete ${m.name}?`)) { addReport({ memberId, memberName: m.name, action:'delete-cancelled' }); return false; }
      saveMembers(members.filter(x=>x.id !== memberId));
      addReport({ memberId, memberName: m.name, action:'delete' });
      renderAll();
      return true;
    };

    // Export CSV
    function exportCSV(){
      const members = getMembers();
      const reports = getReports();
      let csv = 'type,name,id,amount,time,extra\n';
      members.forEach(m => { csv += `member,${m.name},${m.id},${m.savings || 0},,\n`; });
      reports.forEach(r => { csv += `report,${r.memberName || ''},${r.memberId || ''},${r.amount || ''},${r.time || ''},${r.action}\n`; });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'trustvault_export.csv'; a.click(); URL.revokeObjectURL(url);
    }

    // UI wiring
    function renderAll(){
      renderDashboard();
      renderMembersTable();
      ensureSaveMemberSelect();
      renderTransactionsTable();
      renderReportsTable();
      renderNotes();
      renderSettings();
    }

    // Navigation buttons
    $$('nav button').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const page = e.target.dataset.page;
        $$('nav button').forEach(b=>b.classList.remove('active'));
        e.target.classList.add('active');
        $$('section.page').forEach(s=>s.style.display = 'none');
        $('#' + page).style.display = 'block';
        if (page === 'members') renderMembersTable();
        if (page === 'savings') { ensureSaveMemberSelect(); renderTransactionsTable(); }
        if (page === 'reports') renderReportsTable();
        if (page === 'settings') renderSettings();
        if (page === 'dashboard') renderDashboard();
        if (page === 'notes') renderNotes();
      });
    });

    // Login gate handlers
    $('#loginBtn').addEventListener('click', ()=>{
      const pass = $('#loginPassword').value;
      const actual = localStorage.getItem(KEYS.AUTH_PASS) || 'admin123';
      if (!pass) return alert('Enter password');
      if (pass === actual){ $('#loginGate').style.display = 'none'; $('#appRoot').style.display = 'flex'; renderAll(); } else alert('Incorrect password');
    });
    $('#demoBtn').addEventListener('click', ()=>{ $('#loginGate').style.display = 'none'; $('#appRoot').style.display = 'flex'; renderAll(); });

    $('#logoutBtn').addEventListener('click', ()=> { $('#appRoot').style.display = 'none'; $('#loginGate').style.display = 'flex'; });

    // Quick actions
    $('#addMemberBtn').addEventListener('click', ()=>{
      const name = prompt('New member name');
      if (!name) return;
      const arr = getMembers();
      const id = 'm' + Date.now();
      arr.push({ id, name: name.trim(), phone:'', savings:0, active:true });
      saveMembers(arr);
      addReport({ memberId: id, memberName: name.trim(), action:'add-member' });
      renderAll();
    });

    $('#manageMembersBtn').addEventListener('click', ()=> { $$('nav button[data-page="members"]')[0].click(); });

    $('#addSavingBtn').addEventListener('click', ()=> { $$('nav button[data-page="savings"]')[0].click(); });

    $('#exportCsvBtn').addEventListener('click', exportCSV);

    // Apply saving (UI)
    $('#applySaveBtn').addEventListener('click', async ()=>{
      const memberId = $('#saveMemberSelect').value;
      const amount = Number($('#saveAmountInput').value || 0);
      const type = $('#saveType').value;
      if (!memberId || amount <= 0) return alert('Select member and enter amount > 0');

      const settings = getSettings();
      if (type === 'deposit' && Number(settings.minDaily || 0) > 0 && amount < Number(settings.minDaily)){
        const cont = await showModal('Deposit below minimum', `The deposit KES ${amount} is below the daily minimum KES ${settings.minDaily}. Continue?`);
        if (!cont) { addReport({ memberId, memberName: findMemberName(memberId), action: 'deposit-cancelled-below-min', amount }); return; }
      }

      const members = getMembers();
      const m = members.find(x=>x.id===memberId);
      if (!m) return alert('Member not found');
      if (type === 'deposit') {
        m.savings = Number(m.savings||0) + amount;
        addReport({ memberId, memberName: m.name, action: 'deposit', amount });
        showToast('Deposit', `${m.name} deposited KES ${amount} at ${nowStr()}`);
      } else {
        m.savings = Math.max(0, (Number(m.savings||0) - amount));
        addReport({ memberId, memberName: m.name, action: 'withdraw', amount });
        showToast('Withdraw', `${m.name} withdrew KES ${amount} at ${nowStr()}`);
      }
      saveMembers(members);
      renderAll();
      $('#saveAmountInput').value = '';
    });

    function findMemberName(id){ const m = getMembers().find(x=>x.id===id); return m?m.name:id; }

    // Settings save/change
    $('#saveSettingsBtn').addEventListener('click', ()=>{
      const t = Number($('#targetInput').value || 0);
      const min = Number($('#minDailyInput').value || 0);
      const s = getSettings();
      s.target = t; s.minDaily = min; s.autoConfirm = !!$('#autoConfirmCheckbox').checked;
      saveSettings(s);
      addReport({ action:'settings-updated' });
      showToast('Settings', 'Settings saved');
      renderAll();
    });

    $('#changePassBtn').addEventListener('click', ()=>{
      const newp = $('#accessPassword').value.trim();
      if (!newp) return alert('Enter a password');
      localStorage.setItem(KEYS.AUTH_PASS, newp);
      showToast('Access', 'Password changed');
    });

    $('#resetDataBtn').addEventListener('click', ()=>{
      if (!confirm('Reset all data to defaults? This will overwrite members, reports and settings.')) return;
      writeJSON(KEYS.MEMBERS, DEFAULTS.members);
      writeJSON(KEYS.SETTINGS, DEFAULTS.settings);
      writeJSON(KEYS.REPORTS, DEFAULTS.reports);
      writeJSON(KEYS.NOTES, DEFAULTS.notes);
      showToast('Reset', 'Data reset to defaults');
      renderAll();
    });

    $('#saveNotes').addEventListener('click', ()=> {
      saveNotes($('#notesArea').value || '');
      showToast('Notes', 'Saved');
    });

    // Utility: listen for storage changes
    window.addEventListener('storage', (ev) => {
      if ([KEYS.MEMBERS, KEYS.REPORTS, KEYS.SETTINGS, KEYS.NOTES].includes(ev.key)) renderAll();
    });

    // keep last updated text
    setInterval(()=> {
      if (document.getElementById('appRoot').style.display !== 'none') {
        const el = document.querySelector('.sidebar .muted');
        if (el) el.textContent = 'Last update: just now';
      }
    }, 5000);

    // initial show: hide app until login
    document.getElementById('appRoot').style.display = 'none';

    // initial render if demo
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', ()=>{ /* noop */ });
    else { /* noop */ }

    // expose renderAll for debugging
    window.renderTrustAll = renderAll;

    // Initial render after login/democlick will call renderAll()
  })();
  </script>
</body>
</html>
